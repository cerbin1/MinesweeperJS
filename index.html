<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<button class="new-game-button" onclick="location.reload()">Start new game</button>

<button id="d"></button>
<!--<script>
    var d = document.getElementById("d");
    d.addEventListener("click", function () {

    });
</script>-->

<script>
    var width = 40;
    var length = 40;
    var numberOfBombs = 100;
    var isGameDone = false;
    var colors = ["blue", "green", "red", "purple", "orange", "pink"];
    var bombsAndFlags = fillTwoDimensionalArray();
    createBorderTable();
    plantBombs();

    function fillTwoDimensionalArray() {
        var array = [];
        for (var i = 0; i < width; i++) {
            array[i] = [];
            for (var j = 0; j < length; j++) {
                array[i][j] = getDefaultFieldObject();
            }
        }
        return array;
    }

    function getDefaultFieldObject() {
        return {isBomb: false, isFlag: false, numberOfBombsAdjacent: 0, gameField: null};
    }

    function createBorderTable() {
        var gameDiv = document.createElement("div");
        gameDiv.setAttribute("oncontextmenu", "return false");
        document.body.appendChild(gameDiv);

        var table = document.createElement("table");
        table.setAttribute("id", "gameBoard");
        gameDiv.appendChild(table);

        for (var i = 0; i < width; i++) {
            var row = document.createElement("tr");
            row.setAttribute("id", "row" + i.toString());
            table.appendChild(row);

            for (var j = 0; j < length; j++) {
                var cell = document.createElement("td");
                cell.setAttribute("onmousedown", "playerMove(event, this)");
                cell.setAttribute("data-x", i.toString());
                cell.setAttribute("data-y", j.toString());
                row.appendChild(cell);
                bombsAndFlags[i][j].gameField = cell;
            }
        }
    }

    function plantBombs() {
        for (var i = 0; i < numberOfBombs; i++) {
            while (true) {
                var x = Math.floor(Math.random() * bombsAndFlags.length);
                var y = Math.floor(Math.random() * bombsAndFlags.length);
                if (!bombsAndFlags[x][y].isBomb) {
                    bombsAndFlags[x][y].isBomb = true;
                    break;
                }
            }
        }
        countBombsAdjacentToFields();
    }

    function countBombsAdjacentToFields() {
        for (var i = 0; i < bombsAndFlags.length; i++) {
            for (var j = 0; j < bombsAndFlags[i].length; j++) {
                isBombAdjacentToField(i, j);
            }
        }
        displayAllBombs();
    }

    function isBombAdjacentToField(x, y) {
        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                if (x + i >= 0 && x + i <= width - 1 && y + j >= 0 && y + j <= length - 1) {
                    if (bombsAndFlags[x + i][y + j].isBomb) {
                        incrementNumberOfBombsAdjacentToField(x, y);
                    }
                }
            }
        }
    }

    function incrementNumberOfBombsAdjacentToField(x, y) {
        bombsAndFlags[x][y].numberOfBombsAdjacent++;
    }

    function playerMove(event, object) {
        if (!isGameDone) {
            var x = parseInt(object.getAttribute("data-x"));
            var y = parseInt(object.getAttribute("data-y"));
            var cellGame = bombsAndFlags[x][y].gameField;

            if (event.button == 0) {
                discoverField(x, y, cellGame);
            }
            if (event.button == 2) {
                setFlag(x, y, cellGame);
            }
            checkIfPlayerWins();
        }
        else {
            console.log("rozpocznij nowa gre");
        }
    }

    function discoverField(x, y, cellGame) {
        if (!bombsAndFlags[x][y].isFlag) {
            if (bombsAndFlags[x][y].isBomb) {
                displayAllBombs();
                console.log("Przegrales");
                isGameDone = true;
            } else {
                if (bombsAndFlags[x][y].numberOfBombsAdjacent > 0) {
                    cellGame.innerText = bombsAndFlags[x][y].numberOfBombsAdjacent;
                    cellGame.style.color = colorNumberOfBombs(bombsAndFlags[x][y].numberOfBombsAdjacent);
                    cellGame.style.backgroundColor = "darkGray";
                } else {
                    floodFill(x, y, cellGame);
                }
            }
        }
    }

    function setFlag(x, y, fieldToSetFlag) {
        var flagImage = document.createElement("img");
        if (fieldToSetFlag.style.backgroundColor != "darkgray") {
            if (bombsAndFlags[x][y].isFlag) {
                fieldToSetFlag.innerHTML = "";
                flagImage.src = "";
                fieldToSetFlag.appendChild(flagImage);
                bombsAndFlags[x][y].isFlag = false;
            } else {
                flagImage.src = "flag.png";
                fieldToSetFlag.appendChild(flagImage);
                bombsAndFlags[x][y].isFlag = true;
            }
        }
    }

    function displayAllBombs() {
        for (var i = 0; i < bombsAndFlags.length; i++) {
            for (var j = 0; j < bombsAndFlags[i].length; j++) {
                if (bombsAndFlags[i][j].isBomb) {
                    bombsAndFlags[i][j].gameField.style.backgroundColor = "red";
                }
            }
        }
    }



    function checkIfPlayerWins() {
        if (countPointsFromFlags() == numberOfBombs || countPointsFromFieldsReleased() == 0) {
            console.log("wygrales");
            isGameDone = true;
        } else {
            console.log("nie wygrales jeszcze");
            console.log("punkty z flag: " + countPointsFromFlags() + " punkty z pol " + countPointsFromFieldsReleased());
        }
    }

    function countPointsFromFlags() {
        var numberOfPoints = 0;
        for (var i = 0; i < width; i++) {
            for (var j = 0; j < length; j++) {
                if (bombsAndFlags[i][j].isBomb && bombsAndFlags[i][j].isFlag) {
                    numberOfPoints++;
                }
                if (!bombsAndFlags[i][j].isBomb && bombsAndFlags[i][j].isFlag) {
                    numberOfPoints--;
                }
            }
        }
        return numberOfPoints;
    }

    function countPointsFromFieldsReleased() {
        var numberOfPoints = 0;
        for (var i = 0; i < width; i++) {
            for (var j = 0; j < length; j++) {
                if (!bombsAndFlags[i][j].isBomb && bombsAndFlags[i][j].gameField.style.backgroundColor != "darkgray") {
                    numberOfPoints++;
                }
            }
        }
        return numberOfPoints;
    }

    function colorNumberOfBombs(numberOfBombs) {
        return colors[numberOfBombs - 1];
    }

    function floodFill(x, y) {
        if (y < 0 || y > width - 1 || x < 0 || x > length - 1 || bombsAndFlags[x][y].isFlag || bombsAndFlags[x][y].isBomb) {
            console.log("border exceeded");
            return;
        }

        var gameFieldToChange = bombsAndFlags[x][y].gameField;

        if (gameFieldToChange.style.backgroundColor == "darkgray") {
            console.log("already clicked");
            return;
        }

        if (bombsAndFlags[x][y].numberOfBombsAdjacent > 0) {
            gameFieldToChange.innerHTML = bombsAndFlags[x][y].numberOfBombsAdjacent.toString();
            gameFieldToChange.style.color = colorNumberOfBombs(bombsAndFlags[x][y].numberOfBombsAdjacent);
            gameFieldToChange.style.backgroundColor = "darkGray";
            return;
        }
        else {
            gameFieldToChange.style.backgroundColor = "darkGray";
        }

        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                floodFill(x + i, y + j);
            }
        }
    }

</script>
</body>
</html>