<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<button class="new-game-button" onclick="location.reload()">Start new game</button>

<button id="d"></button>
<!--<script>
    var d = document.getElementById("d");
    d.addEventListener("click", function () {

    });
</script>-->

<script>
    var numberOfBombs = 9;
    var isGameDone = false;
    var colors = ["blue", "green", "red", "purple", "orange", "pink"];
    var bombsAndFlags = fillTwoDimensionalArray();
    createBorderTable();
    plantBombs();

    function fillTwoDimensionalArray() {
        function getDefaultFieldObject() {
            return {isBomb: false, isFlag: false, numberOfBombsAdjacent: 0, gameField: null};
        }

        var array = [];
        for (var i = 0; i < 9; i++) {
            array[i] = [];
            for (var j = 0; j < 9; j++) {
                array[i][j] = getDefaultFieldObject();
            }
        }
        return array;
    }

    function createBorderTable() {
        var gameDiv = document.createElement("div");
        gameDiv.setAttribute("oncontextmenu", "return false");
        document.body.appendChild(gameDiv);

        var table = document.createElement("table");
        table.setAttribute("id", "gameBoard");
        gameDiv.appendChild(table);

        for (var i = 0; i < 9; i++) {
            var row = document.createElement("tr");
            row.setAttribute("id", "row" + i.toString());
            table.appendChild(row);

            for (var j = 0; j < 9; j++) {
                var cell = document.createElement("td");
                cell.setAttribute("id", i.toString() + j.toString());
                cell.setAttribute("onmousedown", "playerMove(event, this)");
                document.getElementById("row" + i.toString()).appendChild(cell);
                bombsAndFlags[i][j].gameField = cell;
            }
        }
    }

    function plantBombs() {
        for (var i = 0; i < numberOfBombs; i++) {
            while (true) {
                var first = Math.floor(Math.random() * bombsAndFlags.length);
                var second = Math.floor(Math.random() * bombsAndFlags.length);
                if (!bombsAndFlags[first][second].isBomb) {
                    bombsAndFlags[first][second].isBomb = true;
                    console.log(first, second);
                    console.log(bombsAndFlags[first][second].isBomb);
                    break;
                }
            }
        }
        countBombsAdjacentToFields();
    }

    function countBombsAdjacentToFields() {
        for (var i = 0; i < bombsAndFlags.length; i++) {
            for (var j = 0; j < bombsAndFlags.length; j++) {
                if (i == 0 && j == 0) {
                    isBombAdjacentToField(0, 1, i, j);
                    isBombAdjacentToField(1, 0, i, j);
                    isBombAdjacentToField(1, 1, i, j);
                } else if (i == 0 && j == 8) {
                    isBombAdjacentToField(0, 7, i, j);
                    isBombAdjacentToField(1, 7, i, j);
                    isBombAdjacentToField(1, 8, i, j);
                } else if (i == 8 && j == 0) {
                    isBombAdjacentToField(7, 0, i, j);
                    isBombAdjacentToField(7, 1, i, j);
                    isBombAdjacentToField(8, 0, i, j);
                } else if (i == 8 && j == 8) {
                    isBombAdjacentToField(7, 7, i, j);
                    isBombAdjacentToField(7, 8, i, j);
                    isBombAdjacentToField(8, 7, i, j);
                } else if (i == 0 && j > 0 && j < 8) {
                    isBombAdjacentToField(i, j - 1, i, j);
                    isBombAdjacentToField(i, j + 1, i, j);
                    isBombAdjacentToField(i + 1, j - 1, i, j);
                    isBombAdjacentToField(i + 1, j, i, j);
                    isBombAdjacentToField(i + 1, j + 1, i, j);
                } else if (i > 0 && i < 8 && j == 0) {
                    isBombAdjacentToField(i - 1, j, i, j);
                    isBombAdjacentToField(i - 1, j + 1, i, j);
                    isBombAdjacentToField(i, j + 1, i, j);
                    isBombAdjacentToField(i + 1, j, i, j);
                    isBombAdjacentToField(i + 1, j + 1, i, j);
                } else if (i > 0 && i < 8 && j == 8) {
                    isBombAdjacentToField(i - 1, j - 1, i, j);
                    isBombAdjacentToField(i - 1, j, i, j);
                    isBombAdjacentToField(i, j - 1, i, j);
                    isBombAdjacentToField(i + 1, j - 1, i, j);
                    isBombAdjacentToField(i + 1, j, i, j);
                } else if (i == 8 && j > 0 && j < 8) {
                    isBombAdjacentToField(i - 1, j - 1, i, j);
                    isBombAdjacentToField(i - 1, j, i, j);
                    isBombAdjacentToField(i - 1, j + 1, i, j);
                    isBombAdjacentToField(i, j - 1, i, j);
                    isBombAdjacentToField(i, j + 1, i, j);
                } else {
                    isBombAdjacentToField(i - 1, j - 1, i, j);
                    isBombAdjacentToField(i - 1, j, i, j);
                    isBombAdjacentToField(i - 1, j + 1, i, j);
                    isBombAdjacentToField(i, j - 1, i, j);
                    isBombAdjacentToField(i, j + 1, i, j);
                    isBombAdjacentToField(i + 1, j - 1, i, j);
                    isBombAdjacentToField(i + 1, j, i, j);
                    isBombAdjacentToField(i + 1, j + 1, i, j);
                }
            }
        }
        displayAllBombs();
    }

    function isBombAdjacentToField(first, second, x, y) {
        if (bombsAndFlags[first][second].isBomb) {
            incrementNumberOfBombsAdjacentToField(x, y);
        }
    }

    function incrementNumberOfBombsAdjacentToField(x, y) {
        bombsAndFlags[x][y].numberOfBombsAdjacent++;
    }

    function playerMove(event, object) {
        if (!isGameDone) {
            var x = parseInt(object.id.charAt(0)); // zrobiÄ‡ z tego dwa atrybuty data-x oraz data-y
            var y = parseInt(object.id.charAt(1));
            var divToChange = bombsAndFlags[x][y].gameField;

            if (event.button == 0) {
                discoverField(x, y, divToChange);
            }
            if (event.button == 2) {
                setFlag(x, y, divToChange);
            }
            checkIfPlayerWins();
        }
        else {
            console.log("rozpocznij nowa gre");
        }
    }

    function discoverField(x, y, gameField) {
        console.log("x: " + x + " y: " + y);
        console.log(bombsAndFlags[x][y].isBomb);
        if (bombsAndFlags[x][y].isBomb == true) {
            displayAllBombs();
            console.log("Przegrales");
            isGameDone = true;
        } else {
            if (bombsAndFlags[x][y].numberOfBombsAdjacent > 0) {
                gameField.innerText = bombsAndFlags[x][y].numberOfBombsAdjacent;
                gameField.style.color = colorNumberOfBombs(bombsAndFlags[x][y].numberOfBombsAdjacent);
                gameField.backgroundColor = "darkGray";
            } else {
                floodFill(x, y, gameField);
            }
        }
    }

    function displayAllBombs() {
        for (var i = 0; i < bombsAndFlags.length; i++) {
            for (var j = 0; j < bombsAndFlags.length; j++) {
                if (bombsAndFlags[i][j].isBomb) {
                    bombsAndFlags[i][j].gameField.style.backgroundColor = "red";
                }
            }
        }
    }

    function setFlag(x, y, fieldToSetFlag) {
        var flagImage = document.createElement("img");
        if (fieldToSetFlag.style.backgroundColor != "darkgray") {
            if (bombsAndFlags[x][y].isFlag) {
                fieldToSetFlag.innerHTML = "";
                flagImage.src = "";
                fieldToSetFlag.appendChild(flagImage);
                bombsAndFlags[x][y].isFlag = false;
            } else {
                flagImage.src = "flag.png";
                fieldToSetFlag.appendChild(flagImage);
                bombsAndFlags[x][y].isFlag = true;
            }
        }
    }

    function checkIfPlayerWins() {
        if (countPointsFromFlag() == numberOfBombs || countPointsFromFieldsReleased() == 0) {
            console.log("wygrales");
            isGameDone = true;
        } else {
            console.log("nie wygrales jeszcze");
        }
    }

    function countPointsFromFlag() {
        var numberOfPoints = 0;
        for (var i = 0; i < 9; i++) {
            for (var j = 0; j < 9; j++) {
                if (bombsAndFlags[i][j].isBomb && bombsAndFlags[i][j].isFlag) {
                    numberOfPoints++;
                }
            }
        }
        return numberOfPoints;
    }

    function countPointsFromFieldsReleased() {
        var numberOfPoints = 0;
        for (var i = 0; i < 9; i++) {
            for (var j = 0; j < 9; j++) {
                var isDarkGray = document.getElementById(i.toString() + j.toString()).style.backgroundColor === "darkgray";
                if (!bombsAndFlags[i][j].isBomb && !isDarkGray) {
                    numberOfPoints++;
                }
            }
        }
        return numberOfPoints;
    }

    function colorNumberOfBombs(numberOfBombs) {
        return colors[numberOfBombs - 1];
    }

    function floodFill(x, y) {
        if (y < 0 || y > 8 || x < 0 || x > 8 || bombsAndFlags[x][y].isFlag) {
            console.log("border exceeded");
            return;
        }

        var gameFieldToChange = bombsAndFlags[x][y].gameField;

        if (gameFieldToChange.style.backgroundColor == "darkgray") {
            console.log("already clicked");
            return;
        }

        if (bombsAndFlags[x][y].numberOfBombsAdjacent > 0) {
            gameFieldToChange.innerHTML = bombsAndFlags[x][y].numberOfBombsAdjacent.toString();
            gameFieldToChange.style.color = colorNumberOfBombs(bombsAndFlags[x][y].numberOfBombsAdjacent);
            gameFieldToChange.style.backgroundColor = "darkGray";
            return;
        }
        else {
            gameFieldToChange.style.backgroundColor = "darkGray";
        }

        // are you kidding me bruh? Pani Jolcia chyba petli nie nauczyla
        floodFill(x, y - 1);
        floodFill(x, y + 1);
        floodFill(x + 1, y);
        floodFill(x - 1, y);
        floodFill(x - 1, y - 1);
        floodFill(x - 1, y + 1);
        floodFill(x + 1, y - 1);
        floodFill(x + 1, y + 1);
    }

</script>
</body>
</html>