<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div style="width: 50%; margin: 0 auto; text-align: center">
    <label>
        Bomby<input id="bombs" type="number" value="10">
    </label>

    <label>
        Szerokość<input id="width" type="number" value="9">
    </label>

    <label>
        Wysokość<input id="height" type="number" value="9">
    </label>

    <button style="display: inline-block" class="new-game-button" onclick="startGame()">Start new game</button>

</div>

<!--<script>
    var d = document.getElementById("d");
    d.addEventListener("click", function () {

    });
</script>-->

<script>
    // TODO od tąd
    var width;
    var height;
    var numberOfBombs;
    var isGameDone;
    var colors = ["blue", "green", "red", "purple", "orange", "pink"];
    var cells;
    var isBoardGenerated = false;
    var messageBox;
    var numberOfFlaggedFields = 0;
    // TODO do tąd, takie rzeczy jak width, height, cells itp powinny być w jednym obiekcie.
    startGame();

    function startGame() {
        if (isBoardGenerated) {
            var gameDiv = document.getElementById("gameDiv");
            gameDiv.parentNode.removeChild(gameDiv);
        }
        numberOfBombs = document.getElementById("bombs").value;
        width = document.getElementById("width").value;
        height = document.getElementById("height").value;
        isGameDone = false;
        cells = fillTwoDimensionalArray();
        createBorderTable();
        plantBombs();
        isBoardGenerated = true;

        createMessageBox();
    }

    function createMessageBox() {
        var divToDisplayMessages = document.createElement("div");
        divToDisplayMessages.setAttribute("id", "messageBox");
        document.getElementById("gameDiv").appendChild(divToDisplayMessages);
        messageBox = document.getElementById("messageBox");
    }

    function fillTwoDimensionalArray() {
        var array = [];
        for (var i = 0; i < height; i++) {
            array[i] = [];
            for (var j = 0; j < width; j++) {
                array[i][j] = getDefaultFieldObject();
            }
        }
        return array;
    }

    function getDefaultFieldObject() {
        return {isBomb: false, isFlag: false, numberOfBombsAdjacent: 0, gameField: null, isCellDiscovered: false};
    }

    function createBorderTable() {
        var gameDiv = document.createElement("div");
        gameDiv.setAttribute("id", "gameDiv");
        gameDiv.setAttribute("oncontextmenu", "return false");
        document.body.appendChild(gameDiv);

        var table = document.createElement("table");
        table.setAttribute("id", "gameBoard");
        gameDiv.appendChild(table);

        for (var i = 0; i < height; i++) {
            var row = document.createElement("tr");
            row.setAttribute("id", "row" + i.toString());
            table.appendChild(row);

            for (var j = 0; j < width; j++) {
                var cell = document.createElement("td");
                cell.setAttribute("onmousedown", "playerMove(event, this)");
                cell.setAttribute("data-x", i.toString());
                cell.setAttribute("data-y", j.toString());
                row.appendChild(cell);
                cells[i][j].gameField = cell;
            }
        }
    }

    function plantBombs() {
        for (var i = 0; i < numberOfBombs; i++) {
            while (true) {
                var x = Math.floor(Math.random() * height);
                var y = Math.floor(Math.random() * width);
                if (!cells[x][y].isBomb) {
                    cells[x][y].isBomb = true;
                    break;
                }
            }
        }
        countBombsAdjacentToFields();
    }

    function countBombsAdjacentToFields() {
        for (var i = 0; i < height; i++) {
            for (var j = 0; j < width; j++) {
                isBombAdjacentToField(i, j);
            }
        }
        displayAllBombs();
    }

    function isBombAdjacentToField(x, y) {
        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                if (isFieldInBoard(x + i, y + j)) {
                    if (cells[x + i][y + j].isBomb) {
                        incrementNumberOfBombsAdjacentToField(x, y);
                    }
                }
            }
        }
    }

    function isFieldInBoard(x, y) {
        return (0 <= x && x < height) && (0 <= y && y < width);
    }

    function incrementNumberOfBombsAdjacentToField(x, y) {
        cells[x][y].numberOfBombsAdjacent++;
    }

    function playerMove(event, object) {
        if (isGameDone) {
            messageBox.innerHTML = "Rozpocznij nowa gre";
        } else {
            var x = parseInt(object.getAttribute("data-x"));
            var y = parseInt(object.getAttribute("data-y"));

            if (event.button == 0) {
                discoverField(x, y, cells[x][y]);
            }
            if (event.button == 2) {
                setFlag(cells[x][y]);
            }
            checkIfPlayerWins();
        }
    }

    function discoverField(x, y, cellToDiscover) {
        if (!cellToDiscover.isFlag) { // TODO jak if jest taki duży to lepiej zrobić na początku if (cell.isFlag) return;
            if (!cellToDiscover.isCellDiscovered) {
                if (cellToDiscover.isBomb) {
                    displayAllBombs();
                    messageBox.innerHTML = "przegrales";
                    isGameDone = true;
                } else {
                    if (cellToDiscover.numberOfBombsAdjacent > 0) {
                        cellToDiscover.gameField.innerText = cellToDiscover.numberOfBombsAdjacent;
                        cellToDiscover.gameField.style.color = colorNumberOfBombs(cellToDiscover.numberOfBombsAdjacent);
                        cellToDiscover.gameField.style.backgroundColor = "darkGray";
                        cellToDiscover.isCellDiscovered = true;
                    } else {
                        floodFill(x, y);
                    }
                }
            }
        }
    }

    function setFlag(cellToSetFlag) {
        var flagImage = document.createElement("img");
        if (!cellToSetFlag.isCellDiscovered) {
            if (cellToSetFlag.isFlag) {
                cellToSetFlag.gameField.innerHTML = "";
                flagImage.src = "";
                cellToSetFlag.isFlag = false;
                numberOfFlaggedFields--;
            } else {
                flagImage.src = "flag.png";
                cellToSetFlag.isFlag = true;
                numberOfFlaggedFields++;
            }
            messageBox.innerHTML = "Pozostalo bomb: " + (numberOfBombs - numberOfFlaggedFields);
            cellToSetFlag.gameField.appendChild(flagImage);
        }
    }

    function displayAllBombs() {
        for (var i = 0; i < height; i++) {
            for (var j = 0; j < width; j++) {
                if (cells[i][j].isBomb) {
                    changeFieldToBomb(i, j);
                }
            }
        }
    }

    function changeFieldToBomb(i, j) {
        cells[i][j].gameField.style.backgroundColor = "red";
    }

    function checkIfPlayerWins() {
        if (countPointsFromFlags() == numberOfBombs || countFieldsUndiscovered() == 0) {
            messageBox.innerHTML = "wygrales";
            isGameDone = true;
        } else {
        }
    }

    function countPointsFromFlags() {
        var numberOfPoints = 0;
        for (var i = 0; i < height; i++) {
            for (var j = 0; j < width; j++) {
                if (cells[i][j].isBomb && cells[i][j].isFlag) {
                    numberOfPoints++;
                }
                if (!cells[i][j].isBomb && cells[i][j].isFlag) {
                    numberOfPoints--;
                }
            }
        }
        return numberOfPoints;
    }

    function countFieldsUndiscovered() {
        var numberOfUndiscoveredFields = 0;
        for (var i = 0; i < height; i++) {
            for (var j = 0; j < width; j++) {
                if (!cells[i][j].isBomb && !cells[i][j].isCellDiscovered) {
                    numberOfUndiscoveredFields++;
                }
            }
        }
        return numberOfUndiscoveredFields;
    }

    function colorNumberOfBombs(numberOfBombs) {
        return colors[numberOfBombs - 1];
    }

    function floodFill(x, y) {
        if (isFieldOutsideBoard(x, y) || isFieldEmpty(x, y)) {
            return;
        }

        var cell = cells[x][y];

        if (cell.isCellDiscovered) {
            return;
        }

        if (cell.numberOfBombsAdjacent > 0) {
            cell.gameField.innerHTML = cell.numberOfBombsAdjacent.toString();
            cell.gameField.style.color = colorNumberOfBombs(cell.numberOfBombsAdjacent);
            cell.gameField.style.backgroundColor = "darkGray";
            cell.isCellDiscovered = true;
            return;
        }
        else {
            cell.gameField.style.backgroundColor = "darkGray";
            cell.isCellDiscovered = true;
        }

        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                floodFill(x + i, y + j);
            }
        }
    }

    function isFieldOutsideBoard(x, y) {
        return (0 > y || y > width - 1) || (0 > x || x > height - 1);
    }

    function isFieldEmpty(x, y) {
        return cells[x][y].isFlag || cells[x][y].isBomb;
    }
</script>
</body>
</html>