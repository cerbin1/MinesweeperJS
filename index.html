<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="startGame()">
<div id="game" oncontextmenu="return false">
</div>

<button class="new-game-button" onclick="location.reload()">Start new game</button>
<button class="new-game-button" onclick="">Start new game</button>

<script>
    var booleanBoard = new Array(9);
    var numberOfBombsAdjacentToField = new Array(9);
    var flagsBoard = new Array(9);
    var numberOfBombs = 9;
    var isGameDone = false;
    var colors = ["blue", "green", "red", "purple", "orange", "pink"];

    function startGame() {
        fillTwoDimensionalBoard(booleanBoard, false);
        fillTwoDimensionalBoard(numberOfBombsAdjacentToField, 0);
        fillTwoDimensionalBoard(flagsBoard, 0);
        createBorderTable();
        plantBombs();
    }

    function createBorderTable() {
        var table = document.createElement("TABLE");
        table.setAttribute("id", "board");
        document.body.appendChild(table);

        for (var i = 0; i < 9; i++) {

            var row = document.createElement("TR");
            row.setAttribute("id", "row" + i.toString());
            document.getElementById("board").appendChild(row);

            for (var j = 0; j < 9; j++) {
                var cell = document.createElement("TD");
                cell.setAttribute("id", i.toString() + j.toString());
                cell.setAttribute("onmousedown", "playerMove(event, this)");
                document.getElementById("row" + i.toString()).appendChild(cell);
            }
        }
    }


    function fillTwoDimensionalBoard(array, value) {
        for (var i = 0; i < 9; i++) {
            array[i] = new Array(9).fill(value);
        }
    }

    function plantBombs() {
        for (var i = 0; i < numberOfBombs; i++) {
            while (true) {
                var first = Math.floor(Math.random() * booleanBoard.length);
                var second = Math.floor(Math.random() * booleanBoard.length);
                if (!booleanBoard[first][second]) {
                    booleanBoard[first][second] = true;
                    console.log(first, second);
                    break;
                }
            }
        }
        fillBoard();
    }

    var width = 9;
    var length = 9;

    function fillBoard() {
        for (var i = 0; i < booleanBoard.length; i++) {
            for (var j = 0; j < booleanBoard.length; j++) {
                if (i == 0 && j == 0) {
                    leftTopCorner(0, 0);
                }
                else if (i == 0 && j == 8) {
                    rightTopCorner(0, 8);
                }
                else if (i == 8 && j == 0) {
                    leftBottomCorner(8, 0);
                }
                else if (i == 8 && j == 8) {
                    rightBottomCorner(8, 8);
                }
                else if (i == 0 && j > 0 && j < 8) {
                    topEdge(i, j);
                }
                else if (i > 0 && i < 8 && j == 0) {
                    leftEdge(i, j);
                }
                else if (i > 0 && i < 8 && j == 8) {
                    rightEdge(i, j);
                }
                else if (i == 8 && j > 0 && j < 8) {
                    bottomEdge(i, j);
                }
                else {
                    mid(i, j);
                }
            }
        }
        displayAllBombs();
    }

    function idToString(x, y) {
        return x.toString() + y.toString();
    }

    function setFlag(object) {
        var x = object.id.charAt(0);
        var y = object.id.charAt(1);
        var fieldToSetFlag = document.getElementById(idToString(x, y));
        var flagImage = document.createElement("img");
        if (fieldToSetFlag.style.backgroundColor != "darkgray") {
            if (flagsBoard[x][y]) {
                fieldToSetFlag.innerHTML = "";
                flagImage.src = "";
                fieldToSetFlag.appendChild(flagImage);
                flagsBoard[x][y] = false;
            }
            else {
                flagImage.src = "flag.png";
                fieldToSetFlag.appendChild(flagImage);
                flagsBoard[x][y] = true;
            }
        }
    }
    function playerMove(event, object) {
        if (!isGameDone) {
            if (event.button == 0) {
                discoverField(object);
            }
            if (event.button == 2) {
                setFlag(object);
            }
            checkIfPlayerWins(object.id.charAt(0), object.id.charAt(1));
        }
        else {
            console.log("rozpocznij nowa gre");
        }
    }

    function checkIfPlayerWins() {
        if (countPointsFromFlag() == numberOfBombs || countPointsFromFieldsReleased() == 0) {
            console.log("wygrales");
            isGameDone = true;
        }
        else {
            console.log("nie wygrales jeszcze");
        }
    }

    function countPointsFromFlag() {
        var numberOfPoints = 0;
        for (var i = 0; i < 9; i++) {
            for (var j = 0; j < 9; j++) {
                if (booleanBoard[i][j] && flagsBoard[i][j]) {
                    numberOfPoints++;
                }
            }
        }
        return numberOfPoints;
    }

    function countPointsFromFieldsReleased() {
        var numberOfPoints = 0;
        for (var i = 0; i < 9; i++) {
            for (var j = 0; j < 9; j++) {
                if (!booleanBoard[i][j] && document.getElementById(i.toString() + j.toString()).style.backgroundColor != "darkgray") {
                    numberOfPoints++;
                }
            }
        }
        return numberOfPoints;
    }

    function discoverField(object) {
        if (!isGameDone) {
            var x = parseInt(object.id.charAt(0));
            var y = parseInt(object.id.charAt(1));
            if (booleanBoard[x][y]) {
                displayAllBombs();
                console.log("Przegrales");
                isGameDone = true;
            }
            else {
                var divToChange = document.getElementById((idToString(x, y)));
                if (numberOfBombsAdjacentToField[x][y] > 0) {
                    divToChange.innerText = numberOfBombsAdjacentToField[x][y];
                    colorNumberOfBombs(numberOfBombsAdjacentToField[x][y], divToChange);
                }
                else {
                    floodFill(x, y);
                }
            }
        }
        else {
            alert("Gra jest skoncozna. Rozpocznij nowa gre");
        }
    }

    function colorNumberOfBombs(numberOfBombs, divToChange) {
        if (numberOfBombs == 1) {
            divToChange.style.color = colors[0];
        }
        else if (numberOfBombs == 2) {
            divToChange.style.color = colors[1];
        }
        else if (numberOfBombs == 3) {
            divToChange.style.color = colors[2];
        }
        else if (numberOfBombs == 4) {
            divToChange.style.color = colors[3];
        }
        else if (numberOfBombs == 5) {
            divToChange.style.color = colors[4];
        }
        else if (numberOfBombs == 6) {
            divToChange.style.color = colors[5];
        }

        divToChange.style.backgroundColor = "darkGray";
    }
    function floodFill(x, y) {
        if (y < 0 || y > 8 || x < 0 || x > 8 || flagsBoard[x][y]) {
            console.log("border exceeded");
            return;
        }
        if (document.getElementById((idToString(x, y))).style.backgroundColor == "darkgray") {
            console.log("already clicked");
            return;
        }

        var gameFieldToChange = document.getElementById(idToString(x, y));

        if (numberOfBombsAdjacentToField[x][y] > 0) {
            var divToChange = document.getElementById((idToString(x, y)));
            gameFieldToChange.innerHTML = numberOfBombsAdjacentToField[x][y].toString();
            colorNumberOfBombs(numberOfBombsAdjacentToField[x][y], divToChange);
            return;
        }
        else {
            gameFieldToChange.style.backgroundColor = "darkGray";
        }
        floodFill(x, y - 1);
        floodFill(x, y + 1);
        floodFill(x + 1, y);
        floodFill(x - 1, y);
        floodFill(x - 1, y - 1);
        floodFill(x - 1, y + 1);
        floodFill(x + 1, y - 1);
        floodFill(x + 1, y + 1);
    }

    function leftTopCorner(x, y) {
        if (booleanBoard[0][1] || booleanBoard[1][0] || booleanBoard[1][1]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function rightTopCorner(x, y) {
        if (booleanBoard[0][7] || booleanBoard[1][7] || booleanBoard[1][8]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function leftBottomCorner(x, y) {
        if (booleanBoard[7][0] || booleanBoard[7][1] || booleanBoard[8][0]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function rightBottomCorner(x, y) {
        if (booleanBoard[7][7] || booleanBoard[7][8] || booleanBoard[8][7]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function topEdge(x, y) {
        if (booleanBoard[x][y - 1] || booleanBoard[x][y + 1] || booleanBoard[x + 1][y - 1] || booleanBoard[x + 1][y] || booleanBoard[x + 1][y + 1]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function leftEdge(x, y) {
        if (booleanBoard[x - 1][y] || booleanBoard[x - 1][y + 1] || booleanBoard[x][y + 1] || booleanBoard[x + 1][y] || booleanBoard[x + 1][y + 1]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function rightEdge(x, y) {
        if (booleanBoard[x - 1][y - 1] || booleanBoard[x - 1][y] || booleanBoard[x][y - 1] || booleanBoard[x + 1][y - 1] || booleanBoard[x + 1][y]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function bottomEdge(x, y) {
        if (booleanBoard[x - 1][y - 1] || booleanBoard[x - 1][y] || booleanBoard[x - 1][y + 1] || booleanBoard[x][y - 1] || booleanBoard[x][y + 1]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function mid(x, y) {
        if (booleanBoard[x - 1][y - 1] || booleanBoard[x - 1][y] || booleanBoard[x - 1][y + 1] || booleanBoard[x][y - 1] || booleanBoard[x][y + 1] || booleanBoard[x + 1][y - 1] || booleanBoard[x + 1][y] || booleanBoard[x + 1][y + 1]) {
            numberOfBombsAdjacentToField[parseInt(x)][parseInt(y)]++;
        }
    }

    function displayAllBombs() {
        for (var i = 0; i < booleanBoard.length; i++) {
            for (var j = 0; j < booleanBoard.length; j++) {
                if (booleanBoard[i][j]) {
                    document.getElementById((idToString(i, j))).style.backgroundColor = "red";
                }
            }
        }
    }

</script>
</body>
</html>